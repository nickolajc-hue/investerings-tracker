<!DOCTYPE html>
<html lang="da">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Invest-Master Pro v3.0</title>

    <style>
        :root {
            --primary: #2563eb;
            --success: #16a34a;
            --danger: #dc2626;
            --bg: #f0f2f5;
            --card-bg: #ffffff;
            --text: #1e293b;
        }

        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); padding: 20px; color: var(--text); }
        .container { max-width: 1100px; margin: auto; }
        
        /* Tabs */
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #ddd; padding-bottom: 10px; }
        .tab-btn { padding: 10px 20px; cursor: pointer; border-radius: 8px; border: none; background: #e2e8f0; font-weight: bold; }
        .tab-btn.active { background: var(--primary); color: white; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* Sub-tabs for Allokering */
        .sub-tabs { display: flex; gap: 5px; margin-bottom: 15px; }
        .sub-btn { padding: 5px 12px; font-size: 13px; cursor: pointer; border-radius: 5px; border: 1px solid #ccc; background: white; }
        .sub-btn.active { background: #64748b; color: white; border-color: #64748b; }

        /* UI Elements */
        .card { background: var(--card-bg); padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); margin-bottom: 20px; }
        .cards-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 20px; }
        input, select, button { padding: 10px; border-radius: 6px; border: 1px solid #ddd; font-size: 14px; }
        button { background: var(--primary); color: white; border: none; cursor: pointer; font-weight: bold; }
        
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px; border-bottom: 1px solid #eee; text-align: right; }
        th:first-child, td:first-child { text-align: left; }
        
        .positive { color: var(--success); font-weight: bold; }
        .negative { color: var(--danger); font-weight: bold; }

        #updateModal {
            display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); align-items: center; justify-content: center;
        }
        .modal-content { background: white; padding: 30px; border-radius: 15px; max-width: 500px; width: 90%; position: relative; text-align: center; }
    </style>
</head>

<body>

<div id="updateModal">
    <div class="modal-content">
        <h2>‚ú® Nyhed: Multi-Allokering (v3.0)</h2>
        <p>Du kan nu analysere din portef√∏lje p√• 3 m√•der: efter Type (Aktie/ETF), Land og Sektor!</p>
        <button onclick="closeModal()" style="width: 100%;">Kom i gang</button>
    </div>
</div>

<div class="container">
    <h1>üìà Invest-Master Pro</h1>

    <div class="tabs">
        <button class="tab-btn active" onclick="showTab('dashboard', this)">üè† Dashboard</button>
        <button class="tab-btn" onclick="showTab('allocation', this); renderAllocation();">üìÅ Allokering</button>
        <button class="tab-btn" onclick="showTab('news', this); loadNews();">üì∞ Nyheder</button>
    </div>

    <div id="dashboard" class="tab-content active">
        <div class="cards-grid">
            <div class="card">Investeret<br><b id="invested">0 kr</b></div>
            <div class="card">V√¶rdi<br><b id="value">0 kr</b></div>
            <div class="card">Afkast<br><b id="profit">0 kr</b></div>
            <div class="card">Afkast %<br><b id="profitPct">0%</b></div>
        </div>

        <div class="card">
            <h2>‚ûï Tilf√∏j ny investering</h2>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); gap: 10px;">
                <input id="name" placeholder="Ticker (f.eks. AAPL)">
                <input id="quantity" type="number" placeholder="Antal">
                <input id="buyPrice" type="number" placeholder="K√∏bspris">
                <input id="currentPrice" type="number" placeholder="Nuv. pris">
                <select id="type">
                    <option value="Aktie">Aktie</option>
                    <option value="ETF">ETF</option>
                </select>
                <select id="country">
                    <option value="Danmark">Danmark</option>
                    <option value="USA">USA</option>
                    <option value="Tyskland">Tyskland</option>
                    <option value="Andet">Andet</option>
                </select>
                <select id="sector">
                    <option value="Teknologi">Teknologi</option>
                    <option value="Sundhed">Sundhed</option>
                    <option value="Finans">Finans</option>
                    <option value="Energi">Energi</option>
                    <option value="Forbrug">Forbrug</option>
                </select>
            </div>
            <button onclick="addInvestment()" style="margin-top: 15px; width: 100%;">Tilf√∏j</button>
        </div>

        <div class="card">
            <div style="display:flex; justify-content:space-between; margin-bottom:10px">
                <h2>Holdings</h2>
                <button onclick="updateAllPrices()" id="updateBtn">üîÑ Opdater priser</button>
            </div>
            <table>
                <thead>
                    <tr><th>Aktiv</th><th>Type</th><th>Land</th><th>V√¶rdi</th><th>Handling</th></tr>
                </thead>
                <tbody id="dashboardBody"></tbody>
            </table>
        </div>
    </div>

    <div id="allocation" class="tab-content">
        <div class="card">
            <h2>üìÅ Allokerings-analyse</h2>
            <div class="sub-tabs">
                <button class="sub-btn active" onclick="setAllocView('type', this)">1: Aktie vs ETF</button>
                <button class="sub-btn" onclick="setAllocView('country', this)">2: Lande</button>
                <button class="sub-btn" onclick="setAllocView('sector', this)">3: Sektorer</button>
            </div>
            
            <p id="allocDesc">Viser fordelingen af din portef√∏lje baseret p√• aktivtype.</p>
            
            <table>
                <thead>
                    <tr>
                        <th id="allocHeader">Kategori</th>
                        <th>V√¶rdi</th>
                        <th>Nuv√¶rende %</th>
                    </tr>
                </thead>
                <tbody id="allocationBody"></tbody>
            </table>
        </div>
    </div>

    <div id="news" class="tab-content">
        <div class="card">
            <h2>üì∞ Seneste nyt</h2>
            <div id="newsList">Henter nyheder...</div>
        </div>
    </div>
</div>

<script>
    const VERSION = "3.0";
    let investments = JSON.parse(localStorage.getItem("investments")) || [];
    let currentAllocView = 'type'; 
    const fmt = new Intl.NumberFormat('da-DK', { style: 'currency', currency: 'DKK', maximumFractionDigits: 0 });

    window.onload = function() {
        if (localStorage.getItem("lastSeenVersion") !== VERSION) {
            document.getElementById("updateModal").style.display = "flex";
        }
        render();
    };

    function closeModal() {
        localStorage.setItem("lastSeenVersion", VERSION);
        document.getElementById("updateModal").style.display = "none";
    }

    function showTab(tabId, btn) {
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(tabId).classList.add('active');
        btn.classList.add('active');
    }

    function setAllocView(view, btn) {
        currentAllocView = view;
        document.querySelectorAll('.sub-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        
        const labels = { type: 'Aktivtype', country: 'Land', sector: 'Sektor' };
        document.getElementById('allocHeader').textContent = labels[view];
        renderAllocation();
    }

    function save() { localStorage.setItem("investments", JSON.stringify(investments)); }

    function addInvestment() {
        const i = {
            name: document.getElementById("name").value.toUpperCase(),
            quantity: parseFloat(document.getElementById("quantity").value),
            buyPrice: parseFloat(document.getElementById("buyPrice").value),
            currentPrice: parseFloat(document.getElementById("currentPrice").value),
            type: document.getElementById("type").value,
            country: document.getElementById("country").value,
            sector: document.getElementById("sector").value,
            targetPct: 0 // Kan udvides til at have targets per kategori
        };
        if (!i.name || isNaN(i.quantity)) return;
        investments.push(i);
        save(); render();
    }

    function deleteInvestment(index) {
        investments.splice(index, 1);
        save(); render();
    }

    async function updateAllPrices() {
        const btn = document.getElementById("updateBtn");
        btn.textContent = "Henter...";
        for (let i = 0; i < investments.length; i++) {
            try {
                const res = await fetch(`https://corsproxy.io/?https://query1.finance.yahoo.com/v7/finance/quote?symbols=${investments[i].name}`);
                const data = await res.json();
                if (data.quoteResponse.result[0]) investments[i].currentPrice = data.quoteResponse.result[0].regularMarketPrice;
            } catch (e) { console.error(e); }
        }
        save(); render();
        btn.textContent = "üîÑ Opdater priser";
    }

    function render() {
        let totalInvested = 0, totalValue = 0;
        investments.forEach(i => {
            totalInvested += i.quantity * i.buyPrice;
            totalValue += i.quantity * i.currentPrice;
        });

        document.getElementById("invested").textContent = fmt.format(totalInvested);
        document.getElementById("value").textContent = fmt.format(totalValue);
        document.getElementById("profit").textContent = fmt.format(totalValue - totalInvested);
        document.getElementById("profitPct").textContent = totalInvested ? ((totalValue - totalInvested)/totalInvested*100).toFixed(2) + "%" : "0%";

        const dashBody = document.getElementById("dashboardBody");
        dashBody.innerHTML = investments.map((i, idx) => `
            <tr>
                <td><b>${i.name}</b></td>
                <td>${i.type}</td>
                <td>${i.country}</td>
                <td>${fmt.format(i.quantity * i.currentPrice)}</td>
                <td><button onclick="deleteInvestment(${idx})" style="background:red">X</button></td>
            </tr>
        `).join('');
        
        if (document.getElementById('allocation').classList.contains('active')) renderAllocation();
    }

    function renderAllocation() {
        let totalValue = investments.reduce((sum, i) => sum + (i.quantity * i.currentPrice), 0);
        const groups = {};

        // Grupp√©r data baseret p√• den valgte visning (type, country eller sector)
        investments.forEach(i => {
            const key = i[currentAllocView];
            groups[key] = (groups[key] || 0) + (i.quantity * i.currentPrice);
        });

        const allocBody = document.getElementById("allocationBody");
        allocBody.innerHTML = Object.keys(groups).map(key => {
            const val = groups[key];
            const pct = totalValue ? (val / totalValue * 100).toFixed(1) : 0;
            return `<tr>
                <td><b>${key}</b></td>
                <td>${fmt.format(val)}</td>
                <td>${pct}%</td>
            </tr>`;
        }).join('');
    }

    async function loadNews() {
        const newsList = document.getElementById("newsList");
        if (investments.length === 0) { newsList.innerHTML = "Ingen aktier fundet."; return; }
        const tickers = investments.map(i => i.name).join(',');
        try {
            const res = await fetch(`https://corsproxy.io/?https://query1.finance.yahoo.com/v1/finance/search?q=${tickers}`);
            const data = await res.json();
            const df = new Intl.DateTimeFormat('da-DK', { day: '2-digit', month: 'short', hour: '2-digit', minute: '2-digit' });
            newsList.innerHTML = data.news.map(n => `
                <div style="border-bottom:1px solid #eee; padding:10px 0;">
                    <a href="${n.link}" target="_blank" style="text-decoration:none; color:var(--text); font-weight:bold;">${n.title}</a><br>
                    <small style="color:gray">${df.format(new Date(n.providerPublishTime * 1000))}</small>
                </div>
            `).join('');
        } catch (e) { newsList.innerHTML = "Fejl ved hentning af nyheder."; }
    }
</script>

</body>
</html>
