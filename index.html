<!DOCTYPE html>
<html lang="da">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Invest-Master Pro v5.0</title>

    <style>
        :root {
            --primary: #2563eb;
            --success: #16a34a;
            --danger: #dc2626;
            --bg: #f0f2f5;
            --card-bg: #ffffff;
            --text: #1e293b;
            --unread: #3b82f6;
        }

        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); padding: 20px; color: var(--text); }
        .container { max-width: 1100px; margin: auto; }
        
        /* Tabs */
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #ddd; padding-bottom: 10px; }
        .tab-btn { padding: 10px 20px; cursor: pointer; border-radius: 8px; border: none; background: #e2e8f0; font-weight: bold; }
        .tab-btn.active { background: var(--primary); color: white; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        .card { background: var(--card-bg); padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); margin-bottom: 20px; }
        .cards-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 20px; }
        
        input, select, button { padding: 10px; border-radius: 6px; border: 1px solid #ddd; font-size: 14px; }
        button { background: var(--primary); color: white; border: none; cursor: pointer; font-weight: bold; }
        
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px; border-bottom: 1px solid #eee; text-align: right; }
        th:first-child, td:first-child { text-align: left; }
        
        .positive { color: var(--success); font-weight: bold; }
        .negative { color: var(--danger); font-weight: bold; }

        /* Nyheds-styling */
        .news-item { border-bottom: 1px solid #eee; padding: 15px 0; position: relative; }
        .unread-dot { color: var(--unread); font-size: 24px; line-height: 0; vertical-align: middle; margin-right: 8px; }
        .news-link { text-decoration: none; color: var(--text); font-weight: bold; font-size: 16px; }
        .news-link:visited { color: #64748b; }
        .news-meta { font-size: 12px; color: #64748b; margin-top: 5px; }

        /* Allokerings-input */
        .alloc-input { width: 60px; text-align: center; }
    </style>
</head>

<body>

<div class="container">
    <h1>üìä Invest-Master Pro v5.0</h1>

    <div class="tabs">
        <button class="tab-btn active" onclick="showTab('dashboard', this)">üè† Dashboard</button>
        <button class="tab-btn" onclick="showTab('allocation', this); renderAllocation();">üìÅ Allokering</button>
        <button class="tab-btn" onclick="showTab('news', this); loadNews();">üì∞ Nyheder</button>
    </div>

    <div id="dashboard" class="tab-content active">
        <div class="cards-grid">
            <div class="card">Investeret<br><b id="invested">0 kr</b></div>
            <div class="card">V√¶rdi<br><b id="value">0 kr</b></div>
            <div class="card">Afkast<br><b id="profit">0 kr</b></div>
            <div class="card">Afkast %<br><b id="profitPct">0%</b></div>
        </div>

        <div class="card">
            <h2>‚ûï Tilf√∏j ny investering</h2>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); gap: 10px;">
                <input id="name" placeholder="Ticker (f.eks. AAPL)">
                <input id="quantity" type="number" placeholder="Antal">
                <input id="buyPrice" type="number" placeholder="K√∏bspris">
                <input id="currentPrice" type="number" placeholder="Nuv. pris">
                <select id="currency">
                    <option value="DKK">DKK</option>
                    <option value="USD">USD</option>
                    <option value="EUR">EUR</option>
                </select>
                <input id="subGroup" placeholder="Under-emne (fx Crowdlending)">
            </div>
            <button onclick="addInvestment()" style="margin-top: 15px; width: 100%;">Tilf√∏j til portef√∏lje</button>
        </div>

        <div class="card">
            <div style="display:flex; justify-content:space-between; margin-bottom:10px">
                <h2>Holdings</h2>
                <button onclick="updateAll()" id="updateBtn">üîÑ Opdater live data</button>
            </div>
            <table id="mainTable">
                <thead>
                    <tr><th>Aktiv</th><th>Under-emne</th><th>V√¶rdi (DKK)</th><th>Handling</th></tr>
                </thead>
                <tbody id="dashboardBody"></tbody>
            </table>
        </div>
    </div>

    <div id="allocation" class="tab-content">
        <div class="card">
            <h2>‚öôÔ∏è Definer din M√•l-Allokering</h2>
            <p><small>Indtast dine kategorier og m√•l-procenter herunder.</small></p>
            <table id="allocSettingsTable">
                <thead>
                    <tr><th>Kategori / Under-emne</th><th>M√•l %</th><th>Handling</th></tr>
                </thead>
                <tbody id="allocSettingsBody"></tbody>
            </table>
            <button onclick="addAllocCategory()" style="margin-top: 10px; background: var(--success);">+ Tilf√∏j kategori</button>
        </div>

        <div class="card">
            <h2>üìä Status vs. M√•l</h2>
            <table id="allocStatusTable">
                <thead>
                    <tr><th>Kategori</th><th>Nuv√¶rende (DKK)</th><th>Nuv %</th><th>M√•l %</th><th>Difference</th></tr>
                </thead>
                <tbody id="allocStatusBody"></tbody>
            </table>
        </div>
    </div>

    <div id="news" class="tab-content">
        <div class="card">
            <h2>üì∞ Seneste nyt</h2>
            <div id="newsList">Henter nyheder...</div>
        </div>
    </div>
</div>

<script>
    let investments = JSON.parse(localStorage.getItem("investments")) || [];
    let allocGoals = JSON.parse(localStorage.getItem("allocGoals")) || [
        { name: "ETF", pct: 50 },
        { name: "Udbytte", pct: 40 },
        { name: "Krypto", pct: 10 }
    ];
    let readNews = JSON.parse(localStorage.getItem("readNews")) || [];
    let fxRates = { USD: 7.0, EUR: 7.45, DKK: 1 };
    const fmt = new Intl.NumberFormat('da-DK', { style: 'currency', currency: 'DKK', maximumFractionDigits: 0 });

    // NAVIGATION
    function showTab(tabId, btn) {
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(tabId).classList.add('active');
        btn.classList.add('active');
    }

    // INVESTERINGSLOGIK
    function save() { 
        localStorage.setItem("investments", JSON.stringify(investments));
        localStorage.setItem("allocGoals", JSON.stringify(allocGoals));
        localStorage.setItem("readNews", JSON.stringify(readNews));
    }

    function addInvestment() {
        const i = {
            name: document.getElementById("name").value.toUpperCase(),
            quantity: parseFloat(document.getElementById("quantity").value),
            buyPrice: parseFloat(document.getElementById("buyPrice").value),
            currentPrice: parseFloat(document.getElementById("currentPrice").value),
            currency: document.getElementById("currency").value,
            subGroup: document.getElementById("subGroup").value || "Andet"
        };
        if (!i.name || isNaN(i.quantity)) return;
        investments.push(i);
        save(); render();
    }

    function deleteInvestment(index) { investments.splice(index, 1); save(); render(); }

    // ALLOKERINGSLOGIK
    function addAllocCategory() {
        allocGoals.push({ name: "Ny kategori", pct: 0 });
        renderAllocation();
    }

    function updateGoalPct(index, val) {
        allocGoals[index].pct = parseFloat(val) || 0;
        save();
        renderAllocation();
    }

    function updateGoalName(index, val) {
        allocGoals[index].name = val;
        save();
    }

    function deleteAllocGoal(index) {
        allocGoals.splice(index, 1);
        save();
        renderAllocation();
    }

    // RENDERING
    function render() {
        let totalInvestedDKK = 0, totalValueDKK = 0;
        investments.forEach(i => {
            const rate = fxRates[i.currency] || 1;
            totalInvestedDKK += (i.quantity * i.buyPrice) * rate;
            totalValueDKK += (i.quantity * i.currentPrice) * rate;
        });

        document.getElementById("invested").textContent = fmt.format(totalInvestedDKK);
        document.getElementById("value").textContent = fmt.format(totalValueDKK);
        document.getElementById("profit").textContent = fmt.format(totalValueDKK - totalInvestedDKK);
        document.getElementById("profitPct").textContent = totalInvestedDKK ? ((totalValueDKK - totalInvestedDKK)/totalInvestedDKK*100).toFixed(2) + "%" : "0%";

        const dashBody = document.getElementById("dashboardBody");
        dashBody.innerHTML = investments.map((i, idx) => {
            const valDKK = (i.quantity * i.currentPrice) * (fxRates[i.currency] || 1);
            return `<tr><td><b>${i.name}</b></td><td>${i.subGroup}</td><td>${fmt.format(valDKK)}</td><td><button onclick="deleteInvestment(${idx})" style="background:red">X</button></td></tr>`;
        }).join('');
    }

    function renderAllocation() {
        // Render Indstillinger
        const settingsBody = document.getElementById("allocSettingsBody");
        settingsBody.innerHTML = allocGoals.map((g, idx) => `
            <tr>
                <td><input value="${g.name}" onchange="updateGoalName(${idx}, this.value)" style="width:150px"></td>
                <td><input type="number" value="${g.pct}" onchange="updateGoalPct(${idx}, this.value)" class="alloc-input"> %</td>
                <td><button onclick="deleteAllocGoal(${idx})" style="background:red">X</button></td>
            </tr>
        `).join('');

        // Render Status
        let totalValue = investments.reduce((sum, i) => sum + (i.quantity * i.currentPrice * (fxRates[i.currency]||1)), 0);
        const statusBody = document.getElementById("allocStatusBody");
        
        statusBody.innerHTML = allocGoals.map(g => {
            // Find alle investeringer der matcher denne kategori (fx hvis subGroup indeholder navnet)
            const catValue = investments.filter(i => i.subGroup.toLowerCase().includes(g.name.toLowerCase()))
                                        .reduce((sum, i) => sum + (i.quantity * i.currentPrice * (fxRates[i.currency]||1)), 0);
            
            const curPct = totalValue ? (catValue / totalValue * 100) : 0;
            const diffPct = curPct - g.pct;

            return `<tr>
                <td><b>${g.name}</b></td>
                <td>${fmt.format(catValue)}</td>
                <td>${curPct.toFixed(1)}%</td>
                <td>${g.pct}%</td>
                <td class="${Math.abs(diffPct) < 2 ? '' : (diffPct > 0 ? 'negative' : 'positive')}">
                    ${diffPct > 0 ? '+' : ''}${diffPct.toFixed(1)}%
                </td>
            </tr>`;
        }).join('');
    }

    // NYHEDER MED BLUE DOT
    async function loadNews() {
        const newsList = document.getElementById("newsList");
        if (investments.length === 0) return;
        
        try {
            const res = await fetch(`https://corsproxy.io/?https://query1.finance.yahoo.com/v1/finance/search?q=${investments.map(i=>i.name).join(',')}`);
            const data = await res.json();
            const df = new Intl.DateTimeFormat('da-DK', { day: '2-digit', month: 'short', hour: '2-digit', minute: '2-digit' });
            
            newsList.innerHTML = data.news.map(n => {
                const isUnread = !readNews.includes(n.uuid);
                const pubDate = new Date(n.providerPublishTime * 1000);

                return `
                    <div class="news-item">
                        ${isUnread ? '<span class="unread-dot">‚Ä¢</span>' : ''}
                        <a href="${n.link}" target="_blank" class="news-link" onclick="markAsRead('${n.uuid}')">
                            ${n.title}
                        </a>
                        <div class="news-meta">
                            üìÖ ${df.format(pubDate)} | Kilde: ${n.publisher}
                        </div>
                    </div>
                `;
            }).join('');
        } catch (e) { newsList.innerHTML = "Kunne ikke hente nyheder."; }
    }

    function markAsRead(uuid) {
        if (!readNews.includes(uuid)) {
            readNews.push(uuid);
            save();
            // Vi re-renderer ikke med det samme for ikke at forstyrre klikket, 
            // men prikken vil v√¶re v√¶k n√¶ste gang fanen √•bnes.
        }
    }

    // LIVE OPDATERING
    async function updateAll() {
        const btn = document.getElementById("updateBtn");
        btn.textContent = "Opdaterer...";
        // Hent Valuta
        const fxRes = await fetch(`https://corsproxy.io/?https://query1.finance.yahoo.com/v7/finance/quote?symbols=DKK=X,EURDKK=X`);
        const fxData = await fxRes.json();
        fxRates.USD = fxData.quoteResponse.result.find(r => r.symbol === "DKK=X").regularMarketPrice;
        fxRates.EUR = fxData.quoteResponse.result.find(r => r.symbol === "EURDKK=X").regularMarketPrice;

        // Hent Aktier
        for (let i = 0; i < investments.length; i++) {
            const res = await fetch(`https://corsproxy.io/?https://query1.finance.yahoo.com/v7/finance/quote?symbols=${investments[i].name}`);
            const d = await res.json();
            if (d.quoteResponse.result[0]) investments[i].currentPrice = d.quoteResponse.result[0].regularMarketPrice;
        }
        save(); render();
        btn.textContent = "üîÑ Opdater live data";
    }

    render();
</script>

</body>
</html>
