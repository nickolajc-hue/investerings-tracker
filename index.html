<!DOCTYPE html>
<html lang="da">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Invest-Master Pro v10.0</title>
    <style>
        :root { --primary: #2563eb; --success: #16a34a; --danger: #dc2626; --bg: #f0f2f5; --card-bg: #ffffff; --text: #1e293b; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); padding: 20px; color: var(--text); }
        .container { max-width: 1200px; margin: auto; }
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #ddd; padding-bottom: 10px; }
        .tab-btn { padding: 10px 20px; cursor: pointer; border-radius: 8px; border: none; background: #e2e8f0; font-weight: bold; }
        .tab-btn.active { background: var(--primary); color: white; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .card { background: var(--card-bg); padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); margin-bottom: 20px; }
        input, select, button { padding: 10px; border-radius: 6px; border: 1px solid #ddd; }
        button { background: var(--primary); color: white; border: none; cursor: pointer; font-weight: bold; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px; border-bottom: 1px solid #eee; text-align: right; font-size: 14px; }
        th:first-child, td:first-child { text-align: left; }
        .edit-mode { background: #fef3c7 !important; border: 2px solid #f59e0b !important; }
        .tag { background: #e2e8f0; padding: 2px 6px; border-radius: 4px; font-size: 11px; margin-right: 4px; display: inline-block; }
    </style>
</head>
<body>

<div class="container">
    <h1>üìä Invest-Master Pro v10.0</h1>

    <div class="tabs">
        <button class="tab-btn active" onclick="showTab('dashboard', this)">üè† Dashboard</button>
        <button class="tab-btn" onclick="showTab('allocation', this); renderAllocation();">üìÅ Allokeringer</button>
    </div>

    <div id="dashboard" class="tab-content active">
        <div class="card" id="inputCard">
            <h2 id="formTitle">‚ûï Tilf√∏j/Ret Investering</h2>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px;">
                <input id="name" placeholder="Ticker (fx III)">
                <input id="quantity" type="number" placeholder="Antal">
                <input id="buyPrice" type="number" placeholder="K√∏bspris">
                <input id="currentPrice" type="number" placeholder="Nuv. pris">
                <select id="currency"><option value="USD">USD</option><option value="DKK">DKK</option><option value="EUR">EUR</option></select>
            </div>
            
            <div id="modelSelectionArea" style="margin-top:15px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px; background: #f8fafc; padding: 10px; border-radius: 8px;">
                </div>

            <div style="margin-top: 15px; display: flex; gap: 10px;">
                <button id="addBtn" onclick="saveInvestment()" style="flex: 2;">Gem investering</button>
                <button id="cancelBtn" onclick="resetForm()" style="flex: 1; background: #64748b; display: none;">Annuller</button>
            </div>
        </div>

        <div class="card">
            <h2>Portef√∏lje</h2>
            <table>
                <thead><tr><th>Aktiv</th><th>Allokeringer</th><th>V√¶rdi (DKK)</th><th>Handling</th></tr></thead>
                <tbody id="dashboardBody"></tbody>
            </table>
        </div>
    </div>

    <div id="allocation" class="tab-content">
        <div class="card">
            <h2>üìã Administrer Allokerings-modeller</h2>
            <div style="display:flex; gap:10px; margin-bottom:20px;">
                <button onclick="createNewModel()" style="background:var(--success)">+ Opret ny model (fx Sektor eller Land)</button>
            </div>
            <div id="modelsContainer"></div>
        </div>
    </div>
</div>

<script>
    let investments = JSON.parse(localStorage.getItem("investments_v10")) || [];
    let models = JSON.parse(localStorage.getItem("models_v10")) || [
        { name: "Strategi", hierarchy: [{ name: "Aktier", sub: [{ name: "V√¶kst", pct: 100 }] }] }
    ];
    let editingIndex = -1;
    let fxRates = { USD: 6.85, EUR: 7.45, DKK: 1 };
    const fmt = new Intl.NumberFormat('da-DK', { style: 'currency', currency: 'DKK' });

    function saveToDisk() {
        localStorage.setItem("investments_v10", JSON.stringify(investments));
        localStorage.setItem("models_v10", JSON.stringify(models));
    }

    function showTab(id, btn) {
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        btn.classList.add('active');
        if(id === 'dashboard') buildModelDropdowns();
    }

    // --- ALLOKERING LOGIK ---
    function createNewModel() {
        const name = prompt("Navn p√• model (fx Sektor, Land eller Depot):");
        if (name) { models.push({ name: name, hierarchy: [] }); saveToDisk(); renderAllocation(); }
    }

    function renderAllocation() {
        const container = document.getElementById("modelsContainer");
        container.innerHTML = models.map((m, mIdx) => `
            <div class="card" style="border:1px solid #ddd">
                <div style="display:flex; justify-content:space-between">
                    <h3>Model: ${m.name}</h3>
                    <button onclick="models.splice(${mIdx},1); saveToDisk(); renderAllocation();" style="background:red">Slet model</button>
                </div>
                ${m.hierarchy.map((h, hIdx) => `
                    <div style="margin-left:20px; margin-top:10px; background:#f1f5f9; padding:10px; border-radius:5px;">
                        <input value="${h.name}" onchange="models[${mIdx}].hierarchy[${hIdx}].name=this.value; saveToDisk();">
                        <button onclick="addSub(${mIdx}, ${hIdx})">+ Under-emne</button>
                        <div style="margin-top:5px">
                            ${h.sub.map((s, sIdx) => `
                                <div style="display:flex; gap:5px; margin-bottom:2px">
                                    <input value="${s.name}" onchange="models[${mIdx}].hierarchy[${hIdx}].sub[${sIdx}].name=this.value; saveToDisk();" placeholder="Navn">
                                    <input type="number" value="${s.pct}" onchange="models[${mIdx}].hierarchy[${hIdx}].sub[${sIdx}].pct=this.value; saveToDisk();" style="width:50px">%
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `).join('')}
                <button onclick="models[${mIdx}].hierarchy.push({name:'Nyt Over-emne', sub:[]}); renderAllocation();" style="margin-top:10px">+ Tilf√∏j Over-emne</button>
            </div>
        `).join('');
    }

    function addSub(mIdx, hIdx) {
        models[mIdx].hierarchy[hIdx].sub.push({name: "Nyt under-emne", pct: 0});
        renderAllocation();
    }

    // --- DASHBOARD & REDIGERING ---
    function buildModelDropdowns() {
        const area = document.getElementById("modelSelectionArea");
        area.innerHTML = models.map(m => `
            <div>
                <label style="font-size:12px; display:block">${m.name}</label>
                <select class="model-picker" data-model="${m.name}" style="width:100%">
                    <option value="">-- V√¶lg --</option>
                    ${m.hierarchy.map(h => h.sub.map(s => `<option value="${h.name} > ${s.name}">${h.name} > ${s.name}</option>`).join('')).join('')}
                </select>
            </div>
        `).join('');
    }

    function saveInvestment() {
        const selections = {};
        document.querySelectorAll('.model-picker').forEach(sel => {
            selections[sel.dataset.model] = sel.value;
        });

        const data = {
            name: document.getElementById("name").value.toUpperCase(),
            quantity: parseFloat(document.getElementById("quantity").value),
            buyPrice: parseFloat(document.getElementById("buyPrice").value),
            currentPrice: parseFloat(document.getElementById("currentPrice").value),
            currency: document.getElementById("currency").value,
            allocations: selections
        };

        if (editingIndex > -1) investments[editingIndex] = data;
        else investments.push(data);

        saveToDisk(); resetForm(); render();
    }

    function editInvestment(idx) {
        editingIndex = idx;
        const i = investments[idx];
        document.getElementById("name").value = i.name;
        document.getElementById("quantity").value = i.quantity;
        document.getElementById("buyPrice").value = i.buyPrice;
        document.getElementById("currentPrice").value = i.currentPrice;
        document.getElementById("currency").value = i.currency;
        
        buildModelDropdowns();
        document.querySelectorAll('.model-picker').forEach(sel => {
            if (i.allocations && i.allocations[sel.dataset.model]) {
                sel.value = i.allocations[sel.dataset.model];
            }
        });

        document.getElementById("formTitle").innerText = "üìù Ret aktie
