<!DOCTYPE html>
<html lang="da">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Invest-Master Pro v13.0</title>
    <style>
        :root { --primary: #2563eb; --success: #16a34a; --danger: #dc2626; --bg: #f0f2f5; --card-bg: #ffffff; --text: #1e293b; --unread: #3b82f6; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); padding: 20px; color: var(--text); }
        .container { max-width: 1200px; margin: auto; }
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #ddd; padding-bottom: 10px; }
        .tab-btn { padding: 10px 20px; cursor: pointer; border-radius: 8px; border: none; background: #e2e8f0; font-weight: bold; }
        .tab-btn.active { background: var(--primary); color: white; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .card { background: var(--card-bg); padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); margin-bottom: 20px; }
        input, select, button { padding: 10px; border-radius: 6px; border: 1px solid #ddd; }
        button { background: var(--primary); color: white; border: none; cursor: pointer; font-weight: bold; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px; border-bottom: 1px solid #eee; text-align: right; font-size: 14px; }
        th:first-child, td:first-child { text-align: left; }
        .tag { background: #e2e8f0; padding: 2px 6px; border-radius: 4px; font-size: 11px; margin-right: 4px; display: inline-block; }
        #toast-container { position: fixed; top: 20px; right: 20px; z-index: 1000; }
        .toast { background: #333; color: white; padding: 12px 24px; border-radius: 8px; margin-bottom: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); animation: slideIn 0.3s ease-out; border-left: 5px solid transparent; }
        .toast.success { border-left-color: var(--success); }
        .toast.danger { border-left-color: var(--danger); }
        .toast.info { border-left-color: var(--primary); }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    </style>
</head>
<body>

<div id="toast-container"></div>

<div class="container">
    <h1>üìä Invest-Master Pro v13.0</h1>

    <div class="tabs">
        <button class="tab-btn active" onclick="showTab('dashboard', this)">üè† Dashboard</button>
        <button class="tab-btn" onclick="showTab('allocation', this); renderAllocation();">üìÅ Allokeringer</button>
        <button class="tab-btn" onclick="showTab('news', this); loadNews();">üì∞ Nyheder</button>
    </div>

    <div id="dashboard" class="tab-content active">
        <div class="card" id="inputCard">
            <h2 id="formTitle">‚ûï Tilf√∏j/Ret Investering</h2>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px;">
                <input id="name" placeholder="Ticker (fx III)">
                <input id="quantity" type="number" placeholder="Antal">
                <input id="buyPrice" type="number" placeholder="K√∏bspris">
                <input id="currentPrice" type="number" placeholder="Nuv. pris">
                <select id="currency"><option value="USD">USD</option><option value="DKK">DKK</option><option value="EUR">EUR</option><option value="GBP">GBP</option></select>
            </div>
            <div id="modelSelectionArea" style="margin-top:15px; display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; background: #f8fafc; padding: 10px; border-radius: 8px;"></div>
            <div style="margin-top: 15px; display: flex; gap: 10px;">
                <button onclick="saveInvestment()" style="flex: 2;">Gem investering</button>
                <button id="cancelBtn" onclick="resetForm()" style="flex: 1; background: #64748b; display: none;">Annuller</button>
            </div>
        </div>

        <div class="card">
            <div style="display:flex; justify-content:space-between; align-items: center; margin-bottom: 15px;">
                <h2>Portef√∏lje</h2>
                <button onclick="updateAllPrices()" id="updateBtn" style="background: var(--success);">üîÑ Opdater live data</button>
            </div>
            <table>
                <thead><tr><th>Aktiv</th><th>Allokeringer</th><th>V√¶rdi (DKK)</th><th>Handling</th></tr></thead>
                <tbody id="dashboardBody"></tbody>
            </table>
        </div>
    </div>

    <div id="allocation" class="tab-content">
        <div class="card"><h2>üìÅ Allokeringer</h2><div id="modelsContainer"></div><button onclick="createNewModel()" style="background:var(--success)">+ Ny model</button></div>
    </div>
    <div id="news" class="tab-content"><div class="card"><h2>üì∞ Nyheder</h2><div id="newsList"></div></div></div>
</div>

<script>
    let investments = JSON.parse(localStorage.getItem("investments_v13")) || [];
    let models = JSON.parse(localStorage.getItem("models_v13")) || [{ name: "Strategi", hierarchy: [] }];
    let fxRates = { USD: 6.85, EUR: 7.45, DKK: 1, GBP: 8.70 };
    let editingIndex = -1;
    const fmt = new Intl.NumberFormat('da-DK', { style: 'currency', currency: 'DKK' });

    function showToast(msg, type='success') {
        const c = document.getElementById('toast-container');
        const t = document.createElement('div');
        t.className = `toast ${type}`;
        t.innerText = msg;
        c.appendChild(t);
        setTimeout(() => { t.style.opacity='0'; setTimeout(()=>t.remove(), 500); }, 4000);
    }

    async function updateAllPrices() {
        const btn = document.getElementById("updateBtn");
        btn.innerText = "‚è≥ Forbinder..."; btn.disabled = true;
        let successCount = 0;
        let failCount = 0;

        try {
            // Pr√∏v en alternativ proxy hvis den f√∏rste fejler
            const proxy = "https://api.allorigins.win/raw?url=";
            
            // 1. Valuta
            const fxUrl = encodeURIComponent(`https://query1.finance.yahoo.com/v7/finance/quote?symbols=DKK=X,EURDKK=X,GBPDKK=X`);
            const fxRes = await fetch(proxy + fxUrl);
            const fxData = await fxRes.json();
            if (fxData.quoteResponse.result) {
                fxRates.USD = fxData.quoteResponse.result.find(r => r.symbol === "DKK=X")?.regularMarketPrice || fxRates.USD;
                fxRates.EUR = fxData.quoteResponse.result.find(r => r.symbol === "EURDKK=X")?.regularMarketPrice || fxRates.EUR;
                fxRates.GBP = fxData.quoteResponse.result.find(r => r.symbol === "GBPDKK=X")?.regularMarketPrice || fxRates.GBP;
            }

            // 2. Aktier (Hent √©n efter √©n for at undg√• blokering)
            for (let i = 0; i < investments.length; i++) {
                try {
                    const stockUrl = encodeURIComponent(`https://query1.finance.yahoo.com/v7/finance/quote?symbols=${investments[i].name}`);
                    const res = await fetch(proxy + stockUrl);
                    const data = await res.json();
                    if (data.quoteResponse.result && data.quoteResponse.result[0]) {
                        investments[i].currentPrice = data.quoteResponse.result[0].regularMarketPrice;
                        successCount++;
                    } else { failCount++; }
                } catch (e) { failCount++; }
            }

            localStorage.setItem("investments_v13", JSON.stringify(investments));
            render();
            
            if (failCount > 0) {
                showToast(`Opdateret: ${successCount}. Kunne ikke hente ${failCount} aktier.`, 'danger');
            } else {
                showToast(`Succes! Alle ${successCount} priser er opdateret.`, 'success');
            }
        } catch (e) {
            showToast("Netv√¶rksfejl. Yahoo blokerer midlertidigt. Pr√∏v igen om 2 min.", "danger");
        } finally {
            btn.innerText = "üîÑ Opdater live data"; btn.disabled = false;
        }
    }

    // --- Hj√¶lpefunktioner ---
    function showTab(id, btn) {
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        btn.classList.add('active');
        if(id === 'dashboard') buildModelDropdowns();
    }

    function saveInvestment() {
        const ticker = document.getElementById("name").value.toUpperCase();
        if(!ticker) return showToast("Mangler Ticker", "danger");
        const selections = {};
        document.querySelectorAll('.model-picker').forEach(sel => { selections[sel.dataset.model] = sel.value; });
        const data = {
            name: ticker,
            quantity: parseFloat(document.getElementById("quantity").value) || 0,
            buyPrice: parseFloat(document.getElementById("buyPrice").value) || 0,
            currentPrice: parseFloat(document.getElementById("currentPrice").value) || 0,
            currency: document.getElementById("currency").value,
            allocations: selections
        };
        if (editingIndex > -1) investments[editingIndex] = data;
        else investments.push(data);
        localStorage.setItem("investments_v13", JSON.stringify(investments));
        resetForm(); render();
        showToast(ticker + " gemt!");
    }

    function render() {
        const body = document.getElementById("dashboardBody");
        body.innerHTML = investments.map((i, idx) => {
            const tags = Object.entries(i.allocations || {}).map(([m, v]) => v ? `<span class="tag">${v}</span>` : '').join('');
            const valDKK = i.quantity * i.currentPrice * (fxRates[i.currency] || 1);
            return `<tr><td><b>${i.name}</b></td><td>${tags}</td><td>${fmt.format(valDKK)}</td>
                <td><button onclick="editInvestment(${idx})" style="background:#f59e0b">Ret</button>
                <button onclick="investments.splice(${idx},1);render();" style="background:red">X</button></td></tr>`;
        }).join('');
    }

    function editInvestment(idx) {
        editingIndex = idx; const i = investments[idx];
        document.getElementById("name").value = i.name;
        document.getElementById("quantity").value = i.quantity;
        document.getElementById("buyPrice").value = i.buyPrice;
        document.getElementById("currentPrice").value = i.currentPrice;
        document.getElementById("currency").value = i.currency;
        buildModelDropdowns();
        document.querySelectorAll('.model-picker').forEach(sel => {
            if (i.allocations && i.allocations[sel.dataset.model]) sel.value = i.allocations[sel.dataset.model];
        });
        document.getElementById("formTitle").innerText = "üìù Retter: " + i.name;
        document.getElementById("cancelBtn").style.display = "inline-block";
        window.scrollTo(0,0);
    }

    function resetForm() {
        editingIndex = -1; document.getElementById("formTitle").innerText = "‚ûï Tilf√∏j/Ret Investering";
        document.getElementById("cancelBtn").style.display = "none";
        ["name", "quantity", "buyPrice", "currentPrice"].forEach(id => document.getElementById(id).value = "");
        buildModelDropdowns();
    }

    function buildModelDropdowns() {
        const area = document.getElementById("modelSelectionArea");
        area.innerHTML = models.map(m => `<div><label style="font-size:11px;font-weight:bold">${m.name}</label>
            <select class="model-picker" data-model="${m.name}" style="width:100%"><option value="">-- Ingen --</option>
            ${m.hierarchy.map(h => h.sub.map(s => `<option value="${h.name} > ${s.name}">${h.name} > ${s.name}</option>`).join('')).join('')}
            </select></div>`).join('');
    }

    window.onload = () => { render(); buildModelDropdowns(); };
</script>
</body>
</html>
